
---
title: "GR5320 Project"
output: html_notebook
---


### Step 1: Load Data (Equities in Portfolio)
We download our data from "Yahoo Finance" by using "tidyquant" package. Users can choose any tickers they want.
Here,for mathematical descriptions of model, we use "XOM"&"INTC" as example.
```{r,message=FALSE}
library(ggplot2)
library(MASS)
library(quantmod)
if (!require("quantmod")) {
    install.packages("quantmod")
    library(quantmod)
}
if (!require("tidyquant")) {
    install.packages("tidyquant")
    library(tidyquant)
}
```

**Tickers**

Stock price is orderd from newest to oldest. We set the start date of data is "1990-01-01", and the end date is system date.
```{r}
XOM <- tq_get("XOM", get = "stock.prices",from="1990-01-01")
XOM <- XOM[order(XOM$date,decreasing = T),]
INTC <- tq_get("INTC", get = "stock.prices",from="1990-01-01")
INTC <- INTC[order(INTC$date,decreasing = T),]
```

**Options**
```{r}
imp_vol <- read.csv("../data/volatility.csv")
imp_vol$Date <- as.Date(imp_vol$Date,"%m/%d/%Y")
```

### Step 2: Source function and files 
For the risk calculation system, we have three parts:

* Part 1: Calculate the risk for individual stock
* Part 2: Calculate the risk for portfolio that only including two stocks
* Part 3: Calculate the risk for portfolio that including two stocks and two options

We calculated parameters that calibrated to historical stock prices.
```{r}
# calculate parameter for stocks/portfolio return
source("../code/parameter/winEstGBM.R")
source("../code/parameter/expEstGBM.R")
source("../code/parameter/winEstGBM2.R") #estimated parameters and rho for two stocks
```

```{r}
# historical VaR&ES
source("../code/stock/HVaR.R") #for individual stock & two stocks
source("../code/stock/HES.R")  #for individual stock & two stocks


# monte carlo VaR&ES
source("../code/stock/MC_update.R")  #for individual stock

source("../code/corrgbmsampset.R")  #for two stocks

# Parametric VaR&ES
source("../code/stock/gbmVaR.R")  #for individual stock
source("../code/stock/gbmES.R")   #for individual stock
source("../code/stocks_parametricVaR.R") #for two stocks

# plot graph
source("../code/plotGraph.R")

#others
source("../doc/calculation_measure.R")

# Backtest
source("../code/BackTest.R")
```


### Step 3: Individual Stock Analysis

#### 3.0: Prepare Inputs
```{r}
s1 <- XOM$adjusted
s2 <- INTC$adjusted
dRtn <- 5                                #horizon for day,eg:5 day VaR
year <- 5                                #window length, 5 years
par1 <- winEstGBM(s1,dRtn,year)          #estimated mu and sigma of stock price
par2 <- winEstGBM(s2,dRtn,year)
s0 <- 10000                              #$10,000 dollar position each day
VaRp <- 0.99
ESp <- 0.95

npaths <- 10000
```

#### 3.1: Calculate Individual Stock VaR
```{r,warning=FALSE}
# historical VaR&ES
Hvar <- HVaR_S(s1,VaRp,dRtn,year,s0)
Hes <- ES_S(s1,ESp,dRtn,year,s0)
plotGraph(Hvar,XOM$date)
plotGraph(Hes,XOM$date)

# paramentric VaR
GVaR <- gbmVaR(s0,par1$mu_gbm,par1$sigma_gbm,VaRp,dRtn)
GES <- gbmES(s0,par1$mu_gbm,par1$sigma_gbm,ESp,dRtn)
plotGraph(GVaR,XOM$date)
plotGraph(GES,XOM$date)

# Monte Carlo VaR
MVaR <- MCVaR(s0, par1$mu_gbm, par1$sigma_gbm, VaRp, npaths,year,dRtn)
MES <- MCES(s0, par1$mu_gbm, par1$sigma_gbm, ESp, npaths,year,dRtn)
plotGraph(MVaR,XOM$date)
plotGraph(MES,XOM$date)
```


### Step 4: Portfolio Analysis

#### 4.1: Part 1: Portfolio = weight1*s1 + weight2*s2
##### 4.1.1: Prepare Inputs
```{r}
# Inputs Preparation
source("../code/portfolio_price.R")

prices <- comb.col(XOM$PX_LAST,INTC$PX_LAST)
wgt <- c(156/(156+200),200/(156+200))
positions <- c("long","long") 

dRtn <- 5
year <- 5
v0 <- 10000

portfolio_price <- portfolio_px(prices,wgt,positions,v0)
par_p <- winEstGBM(portfolio_price,dRtn,year)
```

##### 4.1.2: Calculate Portfolio VaR
```{r}
# Historical VaR 
port_Hvar <- HVaR_S(portfolio_price,0.99,dRtn,year,v0)
plotGraph(port_Hvar,INTC$Dates)

# Parametric VaR portfolio follows GBM
Gvar <- gbmVaR(v0,par_p$mu_gbm,par_p$sigma_gbm,0.99,dRtn)
plotGraph(Gvar,INTC$Dates)

# Parametric VaR underlying follows GBM
#-- need to revise all code in this part including inputs --#
source("../doc/loadInput.R")
PVaR <- parametricVaR(a,s0,mu,sigma,rho,p,t,v0)
plotGraph(PVaR,INTC$Dates)

# Monte Carlo (more than 2 stocks situations)
```


#### 4.2: Part 2: Portfolio = Stocks + Options
```{r}
add.col<-function(df, new.col) {
  n.row<-dim(df)[1]
  length(new.col)<-n.row
  cbind(df, new.col)
}

colnames(imp_vol) <- c("Dates","PX","IMP_VOL")

imp_vol$Dates <- format(time(imp_vol$Dates))
INTC$Dates <- format(time(INTC$Dates))

merge(imp_vol,INTC[,c(1,6)],by= "Dates",all = T)
```


### Step 5: Back Test

#### 5.1: Individual Stock
```{r}
#Backtest
BT<-BackTest(s1,Gvar,5,10000)
plotGraph(BT,XOM$date)
```

#### 5.2: Two stocks in the portfolio

#### 5.3: Two stocks + two options in the portfolio
