
---
title: "GR5320 Project"
output: html_notebook
---


### Step 1: Load Data (Equities in Portfolio)
We download our data from "Yahoo Finance" by using "tidyquant" package. Users can choose any tickers they want.
Here,for mathematical descriptions of model, we use "XOM"&"INTC" as example.Users can replace all the "XOM"&"INTC" in this Rmd file with tickers they want.
```{r,message=FALSE}
library(ggplot2)
library(MASS)
library(quantmod)
if (!require("quantmod")) {
    install.packages("quantmod")
    library(quantmod)
}
if (!require("tidyquant")) {
    install.packages("tidyquant")
    library(tidyquant)
}
```

**Tickers**

Stock price is orderd from newest to oldest. We set the start date of data is "1990-01-01", and the end date is system date.
```{r}
XOM <- tq_get("XOM", get = "stock.prices",from="1990-01-01")
XOM <- XOM[order(XOM$date,decreasing = T),]
INTC <- tq_get("INTC", get = "stock.prices",from="1990-01-01")
INTC <- INTC[order(INTC$date,decreasing = T),]
```

**Options**
```{r}
imp_vol <- read.csv("../data/volatility.csv")
imp_vol$Date <- as.Date(imp_vol$Date,"%m/%d/%Y")
intc.option <- read.csv("~/GitHub/risk-mgmt-GroupX/data/intc-option.csv")
xom.option <- read.csv("~/GitHub/risk-mgmt-GroupX/data/xom-option.csv")
```

### Step 2: Source function and files 
For the risk calculation system, we have three parts:

* Part 1: Calculate the risk for individual stock
* Part 2: Calculate the risk for portfolio that only including two stocks
* Part 3: Calculate the risk for portfolio that including two stocks and two options

We calculated parameters that calibrated to historical stock prices.
```{r}
# calculate parameter for stocks/portfolio return
source("../code/parameter/winEstGBM.R")
source("../code/parameter/expEstGBM.R")
source("../code/parameter/winEstGBM2.R") #estimated parameters and rho for two stocks
```

```{r}
# historical VaR&ES
source("../code/stock/HVaR.R")        #for individual stock & portfolio1 two stocks
source("../code/stock/HES.R")         #for individual stock & portfolio1 two stocks
source("../code/Option_HVaR.R")       #for portfolio2 stock+options


# monte carlo VaR&ES
source("../code/stock/MC_update.R")  #for individual stock
source("../code/corrgbmsampset.R")   #for portfolio1 two stocks
source("../code/Option_MVaR.R")      #for portfolio2 stock+options

# Parametric VaR&ES
source("../code/stock/gbmVaR.R")         #for individual stock
source("../code/stock/gbmES.R")          #for individual stock
source("../code/stocks_parametricVaR.R") #for portfolio1 two stocks
source("../code/Option_ParametricVaR.R") #for portfolio2 stock+options

# plot graph
source("../code/plotGraph.R")

#others
source("../doc/calculation_measure.R")

# Backtest
source("../code/BackTest.R")
```


### Step 3: Individual Stock Analysis

#### 3.0: Prepare Inputs
This part allows users to set arbitrary inputs.
```{r}
s1 <- XOM$adjusted
s2 <- INTC$adjusted
dRtn <- 5                                #horizon for day,eg:5 day VaR
year <- 5                                #window length, 5 years
par1 <- winEstGBM(s1,dRtn,year)          #estimated mu and sigma of stock price
par2 <- winEstGBM(s2,dRtn,year)
s0 <- 10000                              #$10,000 dollar position each day
VaRp <- 0.99
ESp <- 0.95
npaths <- 10000
```

#### 3.1: Calculate Individual Stock VaR&ES
```{r,warning=FALSE}
# historical VaR&ES
Hvar <- HVaR_S(s1,VaRp,dRtn,year,s0)
Hes <- ES_S(s1,ESp,dRtn,year,s0)
plotGraph(Hvar,XOM$date)
plotGraph(Hes,XOM$date)

# paramentric VaR
GVaR <- gbmVaR(s0,par1$mu_gbm,par1$sigma_gbm,VaRp,dRtn)
GES <- gbmES(s0,par1$mu_gbm,par1$sigma_gbm,ESp,dRtn)
plotGraph(GVaR,XOM$date)
plotGraph(GES,XOM$date)

# Monte Carlo VaR
MVaR <- MCVaR(s0, par1$mu_gbm, par1$sigma_gbm, VaRp, npaths,year,dRtn)
MES <- MCES(s0, par1$mu_gbm, par1$sigma_gbm, ESp, npaths,year,dRtn)
plotGraph(MVaR,XOM$date)
plotGraph(MES,XOM$date)
```


### Step 4: Portfolio Analysis

#### 4.1: Part 1: Portfolio = weight1*s1 + weight2*s2
##### 4.1.0: Prepare Inputs
```{r}
# This part is allowed to set arbitrary inputs
source("../code/portfolio_value.R")
prices <- comb.col(s1,s2)
positions <- c("long","long") 
wgt <- c(0.6,0.4)
v0 <- 10000

# wgt <- c(156/(156+200),200/(156+200))
# price_date <- cbind.data.frame(XOM$date,prices)
# colnames(price_date) <- c("date","s1","s2")
```

```{r}
port_value <- portfolio_px(prices,wgt,positions,v0)
#estimated parameters of whole portfolio
port_par1 <- winEstGBM(port_value,dRtn,year)

#estimated parameters of each part and covariance matrix in portfolio
port_par2 <- winEstGBM2(prices,dRtn,year)       

shares <- v0*wgt/prices[1,]      #shares number of s1,s2 (notes:set shares number using the newest price)
s0 <- prices[1,]                 #price at start day(eg,1997-01-01)
mu <- port_par2$mu_gbm
sigma <- port_par2$sigma_gbm
rho <- port_par2$rho
```

##### 4.1.1: Calculate Portfolio VaR&ES
```{r}
# Historical VaR&ES 
port_HVaR <- HVaR_S(port_value,VaRp,dRtn,year,v0)
port_HES <- ES_S(port_value,ESp,dRtn,year,v0)
#here,using XOM date for plot because the date of portfolio is same with XOM and INTC
plotGraph(port_HVaR,XOM$date)
plotGraph(port_HES,XOM$date)


# Parametric VaR1(&ES): portfolio follows GBM
GVaR_p1 <- gbmVaR(v0,port_par1$mu_gbm,port_par1$sigma_gbm,VaRp,dRtn)
GES_p1 <- gbmES(v0,port_par1$mu_gbm,port_par1$sigma_gbm,ESp,dRtn)
plotGraph(GVaR_p1,XOM$date)
plotGraph(GES_p1,XOM$date)


# Parametric VaR2: underlying stock follows GBM
PVaR_p1 <- parametricVaR(shares,s0,mu,sigma,rho,VaRp,dRtn,v0)
plotGraph(rev(PVaR_p1),INTC$date)


# Monte Carlo VaR1: portfolio follows GBM
port_MVaR <- MCVaR(v0, port_par1$mu_gbm, port_par1$sigma_gbm, VaRp, npaths,year,dRtn)
port_MES <- MCES(v0, port_par1$mu_gbm, port_par1$sigma_gbm, ESp, npaths,year,dRtn)
plotGraph(port_MVaR,XOM$date)
plotGraph(port_MES,XOM$date)


# Monte Carlo (underlying stock follows GBM)
MCVaR_p1 <- MCVaR_p(v0, port_par2$mu_gbm, port_par2$sigma, port_par2$rho,shares,VaRp, npaths,year,dRtn)
plotGraph(MCVaR_p1,INTC$date)
```


#### 4.2: Part 2: Portfolio = Stocks + Options
```{r}
add.col<-function(df, new.col) {
  n.row<-dim(df)[1]
  length(new.col)<-n.row
  cbind(df, new.col)
}


intc.op <- intc.option[,c(1,7)]
colnames(intc.op) <- c("date","Implied_Vol")
intc.op$date <- as.Date(intc.op$date,"%m/%d/%y")
option <- merge(INTC,intc.option,by="date")
```


### Step 5: Back Test

#### 5.1: Individual Stock
```{r}
#Backtest
BT<-BackTest(s1,Gvar,5,10000)
plotGraph(BT,XOM$date)
```

#### 5.2: Two stocks in the portfolio

#### 5.3: Two stocks + two options in the portfolio
